# 前端 Dockerfile
# 使用多阶段构建，分为构建阶段和生产阶段

# 1. 构建阶段
# 使用 node:20 作为基础镜像，命名为 build
FROM node:20 AS build

# 设置工作目录，后续命令都在这个目录下执行
WORKDIR /app

# 复制 package.json 和 package-lock.json（如果存在）到工作目录
# 这一步的目的是先安装依赖，然后再复制其他文件
# 这样可以利用 Docker 的缓存机制，只有当 package.json 变化时才会重新安装依赖
COPY package*.json ./

# 安装项目依赖
RUN npm install

# 复制所有文件到工作目录
# 现在复制文件，是因为如果先复制文件，那么每次修改代码都会重新安装依赖，导致构建变慢
COPY . .

# 构建项目，生成静态文件
# 构建后的文件会输出到 /app/dist 目录
RUN npm run build

# 2. 生产阶段
# 使用 nginx:alpine 作为基础镜像，这是一个轻量级的 Nginx 镜像
FROM nginx:alpine

# 从构建阶段复制构建好的静态文件到 Nginx 的静态文件目录
# --from=build 表示从前面命名为 build 的构建阶段复制文件
# /app/dist 是构建阶段生成的静态文件目录
# /usr/share/nginx/html 是 Nginx 默认的静态文件目录
COPY --from=build /app/dist /usr/share/nginx/html

# 复制自定义的 nginx 配置文件到 Nginx 容器中
# 覆盖默认的配置文件，用于处理单页应用路由
COPY nginx.conf /etc/nginx/conf.d/default.conf

# 暴露 80 端口
# 这个命令只是声明容器会使用 80 端口，实际的端口映射在 docker-compose.yml 中配置
EXPOSE 80

# 启动 Nginx 服务
# 使用 "daemon off;" 参数让 Nginx 在前台运行，这样 Docker 可以监控进程
CMD ["nginx", "-g", "daemon off;"]
