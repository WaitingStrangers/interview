# Nginx 服务器配置文件
# 定义一个服务器块，处理所有 80 端口的请求
server {
    # 监听 80 端口，处理 HTTP 请求
    listen 80;

    # 定义根路径的处理规则
    # 当用户访问 http://localhost/ 时，将请求代理到 frontend 容器的 80 端口
    location / {
        # proxy_pass 指令：将请求代理到指定的后端服务器
        # http://frontend:80：Docker 网络中 frontend 容器的 80 端口
        proxy_pass http://frontend:80;
        
        # 设置代理使用的 HTTP 版本为 1.1
        proxy_http_version 1.1;
        
        # 以下配置用于支持 WebSocket 连接
        # 传递 Upgrade 头，用于协议升级
        proxy_set_header Upgrade $http_upgrade;
        # 传递 Connection 头，指定连接类型
        proxy_set_header Connection 'upgrade';
        # 传递 Host 头，保持原始请求的主机名
        proxy_set_header Host $host;
        # 禁用缓存，确保每次请求都到达后端服务器
        proxy_cache_bypass $http_upgrade;
    }

    # 定义 API 路径的处理规则
    # 当用户访问 http://localhost/api/ 时，将请求代理到 backend 容器的 3000 端口
    location /api/ {
        # proxy_pass 指令：将请求代理到指定的后端服务器
        # http://backend:3000/：Docker 网络中 backend 容器的 3000 端口
        # 末尾的 / 表示将 /api/ 路径前缀移除后转发，例如 /api/questions 会转发为 /questions
        proxy_pass http://backend:3000/;  # 代理到后端服务
        
        # 设置代理使用的 HTTP 版本为 1.1
        proxy_http_version 1.1;
        
        # 以下配置用于支持 WebSocket 连接
        # 传递 Upgrade 头，用于协议升级
        proxy_set_header Upgrade $http_upgrade;
        # 传递 Connection 头，指定连接类型
        proxy_set_header Connection 'upgrade';
        # 传递 Host 头，保持原始请求的主机名
        proxy_set_header Host $host;
        # 禁用缓存，确保每次请求都到达后端服务器
        proxy_cache_bypass $http_upgrade;
    }
}
